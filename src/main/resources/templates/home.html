<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>또간집 맛집 지도</title>
    <link href="/common.css" rel="stylesheet">
    <script src="/common.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0jcn2x4ikv"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0jcn2x4ikv&submodules=geocoder"></script>
</head>

<body>
<div id="title"><span class="title-decoration">또</span><span class="title-decoration">간</span><span class="title-decoration">집</span>맛집 지도</div>
<div id="container"><div id="map"></div><div id="side"><input type="text" id="input-addr" placeholder="주소를 입력해주세요."><input type="button" id="btn-coordinate" value="좌표 얻기"><div id="div-addr-console"></div></div></div>

<script>
    var mapOptions = { center: new naver.maps.LatLng(37.3595704, 127.105399), zoom: 10, zoomControl: true }; // 지도 로드 시 초기 값 세팅
    var map = new naver.maps.Map('map', mapOptions); // 해당 좌표 축으로 지도 표시

    document.addEventListener('click', (e) => {
        if(e.target.id == 'btn-coordinate') {
            const addr = document.getElementById('input-addr').value;

            if(!addr) { alert('업체명을 입력해주세요.'); } // search 사용 시에는 업체명으로 변경
            else {
                $.ajax({
                    type: 'get', url: '/naver/search', data: {'addr': encodeURIComponent(addr)}, dataType: 'json',
                    success: (data) => {
                        const items = data.items;
                        const divAddrConsole = document.getElementById('div-addr-console');

                        items.forEach((i) => {
                            console.log(i);
                            const newDiv = document.createElement('div');
                            newDiv.classList.add('div-restaurant-info');
                            const newP = document.createElement('p');
                            const title = document.createTextNode(`업체명: ${i.title}`);
                            newP.append(title);
                            const newP2 = document.createElement('p');
                            const category = document.createTextNode(`카테고리: ${i.category}`);
                            newP2.append(category);
                            const newP3 = document.createElement('p');
                            const address = document.createTextNode(`주소: ${i.address}`);
                            newP3.append(address);
                            newDiv.append(newP);
                            newDiv.append(newP2);
                            newDiv.append(newP3);
                            divAddrConsole.append(newDiv);

                            const mapx = i.mapx;
                            const mapy = i.mapy;
                            const point = new naver.maps.Point(mapx, mapy);
                            const position = naver.maps.TransCoord.fromTM128ToLatLng(point);
                            console.log(`position.x = ${position.x}`);
                            console.log(`position.y = ${position.y}`);

                            var map = new naver.maps.Map('map', { center: position, zoom: 19, zoomControl: true });
                            var marker = new naver.maps.Marker({ position: position, map: map });
                        });
                    },
                    error: (x, e) => { console.log(x); console.log(e); }
                })

                // $.ajax({
                //     type: 'get', url: '/naver/maps', data: {'addr': encodeURIComponent(addr)}, dataType: 'json',
                //     success: (data) => {
                //         const addr = data.addresses[0];
                //         const divAddrConsole = document.getElementById('div-addr-console');
                //         divAddrConsole.innerHTML = `<p>도로명 주소: <span id="addr">${addr.roadAddress}</span></p><p>지번 주소: <span id="addr">${addr.jibunAddress}</span></p><p>x: <span id="x">${addr.x}</span></p><p>y: <span id="y">${addr.y}</span></p>`;
                //
                //         console.log(`addr.y = ${addr.y}`);
                //         console.log(`addr.x = ${addr.x}`);
                //
                //         // 마커 표시
                //         var map = new naver.maps.Map('map', { center: new naver.maps.LatLng(addr.y, addr.x), zoom: 19, zoomControl: true });
                //         var marker = new naver.maps.Marker({ position: new naver.maps.LatLng(addr.y, addr.x), map: map });
                //
                //         // 정보창 표시
                //         var contentString = [`<div class="iw_inner"><p>${addr.jibunAddress}</p><p><a href="https://search.naver.com/search.naver?query=${addr.jibunAddress}" target="_blank">해당 주소 네이버로 검색하기</a></p></div>`].join('');
                //         var infowindow = new naver.maps.InfoWindow({ content: contentString });
                //         naver.maps.Event.addListener(marker, "click", (e) => {
                //             if (infowindow.getMap()) { infowindow.close(); }
                //             else { infowindow.open(map, marker); }
                //         });
                //         infowindow.open(map, marker);
                //     },
                //     error: (x, e) => { console.log(x); console.log(e); }
                // })
            }
        }
    });
</script>
</body>
</html>